# 图片水印工具 - 功能点拆解文档

## 项目概述
基于Python 3.6开发的图片水印工具，使用tkinter作为GUI框架，Pillow进行图像处理。

## 功能模块拆解

### 模块1: 项目基础架构 (Foundation)

#### 1.1 项目初始化
- **文件**: `main.py`
- **功能**: 程序入口点，初始化主窗口
- **技术要求**: 
  - 创建tkinter主窗口
  - 设置窗口标题、大小、居中显示
  - 配置窗口关闭事件
- **依赖**: tkinter, sys, os

#### 1.2 依赖管理
- **文件**: `requirements.txt`
- **功能**: 管理项目依赖包
- **内容**:
  ```
  Pillow>=5.4.0
  exifread>=2.3.2
  ```
- **技术要求**: 确保Python 3.6兼容性

#### 1.3 配置管理
- **文件**: `config.py`
- **功能**: 管理应用配置和常量
- **技术要求**:
  - 定义支持的图片格式
  - 定义默认水印参数
  - 配置文件路径常量

### 模块2: 文件处理系统 (File Management)

#### 2.1 图片导入功能
- **文件**: `file_manager.py`
- **类**: `ImageFileManager`
- **方法**:
  - `import_single_image()`: 导入单张图片
  - `import_multiple_images()`: 批量导入图片
  - `import_folder()`: 导入整个文件夹
  - `validate_image_format()`: 验证图片格式
- **技术要求**:
  - 支持拖拽导入
  - 文件格式验证 (JPEG, PNG, BMP, TIFF)
  - 错误处理和用户提示
  - 返回图片路径列表

#### 2.2 图片列表管理
- **文件**: `image_list.py`
- **类**: `ImageListManager`
- **方法**:
  - `add_image()`: 添加图片到列表
  - `remove_image()`: 从列表移除图片
  - `get_image_list()`: 获取图片列表
  - `clear_list()`: 清空图片列表
- **技术要求**:
  - 存储图片路径和缩略图
  - 支持列表更新通知
  - 内存优化（缩略图缓存）

#### 2.3 图片导出功能
- **文件**: `export_manager.py`
- **类**: `ExportManager`
- **方法**:
  - `export_single()`: 导出单张图片
  - `export_batch()`: 批量导出
  - `set_output_folder()`: 设置输出文件夹
  - `generate_filename()`: 生成输出文件名
- **技术要求**:
  - 支持JPEG/PNG输出格式
  - 文件命名规则（前缀、后缀）
  - 防止覆盖原文件
  - 进度显示

### 模块3: 水印处理系统 (Watermark Engine)

#### 3.1 文本水印处理
- **文件**: `text_watermark.py`
- **类**: `TextWatermark`
- **方法**:
  - `create_text_watermark()`: 创建文本水印
  - `set_font()`: 设置字体样式
  - `set_color()`: 设置颜色
  - `set_transparency()`: 设置透明度
  - `add_shadow()`: 添加阴影效果
  - `add_outline()`: 添加描边效果
- **技术要求**:
  - 使用Pillow的ImageDraw
  - 支持系统字体
  - 透明度处理
  - 文本测量和定位

#### 3.2 图片水印处理
- **文件**: `image_watermark.py`
- **类**: `ImageWatermark`
- **方法**:
  - `load_watermark_image()`: 加载水印图片
  - `resize_watermark()`: 调整水印大小
  - `set_transparency()`: 设置透明度
  - `apply_watermark()`: 应用水印到图片
- **技术要求**:
  - 支持PNG透明通道
  - 水印缩放算法
  - Alpha通道处理

#### 3.3 水印位置管理
- **文件**: `watermark_position.py`
- **类**: `WatermarkPosition`
- **方法**:
  - `set_preset_position()`: 设置预设位置
  - `set_custom_position()`: 设置自定义位置
  - `calculate_position()`: 计算水印位置
  - `validate_position()`: 验证位置有效性
- **技术要求**:
  - 九宫格位置计算
  - 边界检测
  - 拖拽位置更新

### 模块4: EXIF数据处理 (EXIF Handler)

#### 4.1 EXIF信息读取
- **文件**: `exif_handler.py`
- **类**: `EXIFHandler`
- **方法**:
  - `read_exif_data()`: 读取EXIF数据
  - `extract_datetime()`: 提取拍摄时间
  - `format_datetime()`: 格式化时间显示
  - `has_exif_data()`: 检查是否有EXIF数据
- **技术要求**:
  - 使用exifread库
  - 错误处理（无EXIF数据）
  - 时间格式转换

#### 4.2 EXIF水印集成
- **文件**: `exif_watermark.py`
- **类**: `EXIFWatermark`
- **方法**:
  - `create_exif_watermark()`: 创建EXIF时间水印
  - `update_datetime()`: 更新时间显示
  - `apply_to_image()`: 应用到图片
- **技术要求**:
  - 与文本水印系统集成
  - 实时更新机制

### 模块5: 用户界面系统 (GUI Components)

#### 5.1 主窗口布局
- **文件**: `main_window.py`
- **类**: `MainWindow`
- **组件**:
  - 菜单栏
  - 工具栏
  - 图片列表区域
  - 预览区域
  - 控制面板
- **技术要求**:
  - 响应式布局
  - 窗口大小调整
  - 组件事件绑定

#### 5.2 图片预览组件
- **文件**: `preview_widget.py`
- **类**: `PreviewWidget`
- **方法**:
  - `display_image()`: 显示图片
  - `update_preview()`: 更新预览
  - `handle_click()`: 处理点击事件
  - `handle_drag()`: 处理拖拽事件
- **技术要求**:
  - Canvas组件使用
  - 图片缩放显示
  - 鼠标交互处理

#### 5.3 控制面板组件
- **文件**: `control_panel.py`
- **类**: `ControlPanel`
- **组件**:
  - 水印类型选择
  - 文本输入框
  - 样式设置控件
  - 位置选择按钮
  - 导出设置
- **技术要求**:
  - 各种tkinter控件
  - 事件回调机制
  - 参数验证

#### 5.4 图片列表组件
- **文件**: `image_list_widget.py`
- **类**: `ImageListWidget`
- **方法**:
  - `add_image_item()`: 添加图片项
  - `remove_image_item()`: 移除图片项
  - `select_image()`: 选择图片
  - `update_thumbnail()`: 更新缩略图
- **技术要求**:
  - Listbox或Treeview组件
  - 缩略图显示
  - 选择状态管理

### 模块6: 模板管理系统 (Template Management)

#### 6.1 水印模板存储
- **文件**: `template_manager.py`
- **类**: `TemplateManager`
- **方法**:
  - `save_template()`: 保存模板
  - `load_template()`: 加载模板
  - `delete_template()`: 删除模板
  - `list_templates()`: 列出所有模板
- **技术要求**:
  - JSON格式存储
  - 文件系统操作
  - 模板验证

#### 6.2 模板UI组件
- **文件**: `template_widget.py`
- **类**: `TemplateWidget`
- **方法**:
  - `show_template_dialog()`: 显示模板对话框
  - `load_template_settings()`: 加载模板设置
  - `apply_template()`: 应用模板
- **技术要求**:
  - 对话框窗口
  - 模板选择界面
  - 设置应用机制

### 模块7: 批处理系统 (Batch Processing)

#### 7.1 批处理队列
- **文件**: `batch_processor.py`
- **类**: `BatchProcessor`
- **方法**:
  - `add_to_queue()`: 添加到处理队列
  - `process_queue()`: 处理队列
  - `pause_processing()`: 暂停处理
  - `resume_processing()`: 恢复处理
- **技术要求**:
  - 队列数据结构
  - 线程安全处理
  - 进度跟踪

#### 7.2 进度显示组件
- **文件**: `progress_widget.py`
- **类**: `ProgressWidget`
- **方法**:
  - `show_progress()`: 显示进度
  - `update_progress()`: 更新进度
  - `hide_progress()`: 隐藏进度
- **技术要求**:
  - Progressbar组件
  - 进度计算
  - 取消操作支持

### 模块8: 工具和辅助功能 (Utilities)

#### 8.1 图片工具类
- **文件**: `image_utils.py`
- **类**: `ImageUtils`
- **方法**:
  - `resize_image()`: 调整图片大小
  - `create_thumbnail()`: 创建缩略图
  - `get_image_info()`: 获取图片信息
  - `validate_image()`: 验证图片
- **技术要求**:
  - Pillow图像处理
  - 尺寸计算
  - 格式转换

#### 8.2 文件工具类
- **文件**: `file_utils.py`
- **类**: `FileUtils`
- **方法**:
  - `get_safe_filename()`: 获取安全文件名
  - `create_directory()`: 创建目录
  - `get_file_size()`: 获取文件大小
  - `backup_file()`: 备份文件
- **技术要求**:
  - 文件系统操作
  - 路径处理
  - 错误处理

#### 8.3 配置工具类
- **文件**: `config_utils.py`
- **类**: `ConfigUtils`
- **方法**:
  - `load_config()`: 加载配置
  - `save_config()`: 保存配置
  - `get_default_config()`: 获取默认配置
  - `validate_config()`: 验证配置
- **技术要求**:
  - JSON配置文件
  - 配置验证
  - 默认值处理

## 开发优先级

### 第一阶段 (核心功能)
1. 项目基础架构 (模块1)
2. 文件处理系统 (模块2)
3. 文本水印处理 (模块3.1)
4. 基础用户界面 (模块5.1, 5.2, 5.3)

### 第二阶段 (增强功能)
1. 水印位置管理 (模块3.3)
2. EXIF数据处理 (模块4)
3. 图片列表组件 (模块5.4)
4. 图片导出功能 (模块2.3)

### 第三阶段 (高级功能)
1. 图片水印处理 (模块3.2)
2. 模板管理系统 (模块6)
3. 批处理系统 (模块7)
4. 工具和辅助功能 (模块8)

## 技术实现要点

### Python 3.6兼容性
- 使用f-string语法 (Python 3.6+)
- 避免使用较新的语法特性
- 确保所有依赖包支持Python 3.6

### 内存管理
- 及时释放大图片对象
- 使用缩略图减少内存占用
- 实现图片懒加载

### 错误处理
- 完善的异常捕获机制
- 用户友好的错误提示
- 日志记录系统

### 性能优化
- 异步处理大图片
- 进度反馈机制
- 合理的缓存策略

## 测试策略

### 单元测试
- 每个模块独立测试
- 边界条件测试
- 异常情况测试

### 集成测试
- 模块间交互测试
- 完整流程测试
- 性能测试

### 用户测试
- 界面易用性测试
- 功能完整性测试
- 兼容性测试
